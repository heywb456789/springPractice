<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>투표 생성/수정 - 나라 걱정 클럽 관리자</title>
</head>
<body>

<th:block th:fragment="content">
    <!-- 투표 생성/수정 폼 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form th:action="${poll != null && poll.id != null} ? @{/admin/polls/{id}/update(id=${poll.id})} : @{/admin/polls/store}" 
                          method="post" 
                          id="pollForm">
                        
                        <div class="row">
                            <!-- 투표 기본 정보 -->
                            <div class="col-xl-8 col-lg-7">
                                <!-- 투표 제목 -->
                                <div class="mb-3">
                                    <label for="pollTitle" class="form-label">투표 제목 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="pollTitle" name="title"
                                           th:value="${poll != null} ? ${poll.title} : ''" 
                                           placeholder="투표 제목을 입력하세요" required>
                                </div>
                                
                                <!-- 투표 설명 -->
                                <div class="mb-3">
                                    <label for="pollDescription" class="form-label">설명</label>
                                    <textarea class="form-control" id="pollDescription" name="description" rows="3"
                                              placeholder="투표에 대한 설명을 입력하세요" th:text="${poll != null} ? ${poll.description} : ''"></textarea>
                                </div>
                                
                                <!-- 투표 항목 -->
                                <div class="mb-3">
                                    <label class="form-label">투표 항목 <span class="text-danger">*</span></label>
                                    <div class="table-responsive">
                                        <table class="table table-centered table-hover mb-0">
                                            <thead>
                                                <tr>
                                                    <th>항목</th>
                                                    <th style="width: 100px;">색상</th>
                                                    <th style="width: 100px;">순서</th>
                                                    <th style="width: 80px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="poll-options">
                                                <!-- 기존 항목 -->
                                                <tr th:each="option, status : ${poll != null ? poll.options : {}}" th:id="'option-row-' + ${status.index}">
                                                    <td>
                                                        <input type="text" class="form-control poll-option" 
                                                               th:name="'options[' + ${status.index} + '].text'" 
                                                               th:value="${option.text}" 
                                                               placeholder="항목 입력" required>
                                                    </td>
                                                    <td>
                                                        <input type="color" class="form-control form-control-color"
                                                               th:name="'options[' + ${status.index} + '].color'" 
                                                               th:value="${option.color}" 
                                                               value="#3874ff">
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control poll-option-order"
                                                               th:name="'options[' + ${status.index} + '].order'" 
                                                               th:value="${option.order}" 
                                                               th:placeholder="${status.index + 1}" min="1" value="1">
                                                    </td>
                                                    <td class="text-center">
                                                        <a href="javascript:void(0);" class="text-danger remove-option">
                                                            <i class="mdi mdi-trash-can-outline font-size-18"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                                
                                                <!-- 샘플 항목 -->
                                                <tr th:if="${poll == null}" id="option-row-0">
                                                    <td>
                                                        <input type="text" class="form-control poll-option" name="options[0].text" placeholder="항목 입력" required>
                                                    </td>
                                                    <td>
                                                        <input type="color" class="form-control form-control-color" name="options[0].color" value="#3874ff">
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control poll-option-order" name="options[0].order" placeholder="1" min="1" value="1">
                                                    </td>
                                                    <td class="text-center">
                                                        <a href="javascript:void(0);" class="text-danger remove-option">
                                                            <i class="mdi mdi-trash-can-outline font-size-18"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                                <tr th:if="${poll == null}" id="option-row-1">
                                                    <td>
                                                        <input type="text" class="form-control poll-option" name="options[1].text" placeholder="항목 입력" required>
                                                    </td>
                                                    <td>
                                                        <input type="color" class="form-control form-control-color" name="options[1].color" value="#ff5b5b">
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control poll-option-order" name="options[1].order" placeholder="2" min="1" value="2">
                                                    </td>
                                                    <td class="text-center">
                                                        <a href="javascript:void(0);" class="text-danger remove-option">
                                                            <i class="mdi mdi-trash-can-outline font-size-18"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="text-center mt-2">
                                        <button type="button" class="btn btn-sm btn-secondary" id="add-option">
                                            <i class="mdi mdi-plus-circle me-1"></i> 항목 추가
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 투표 설정 -->
                                <div class="mb-3">
                                    <label class="form-label">투표 설정</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input type="checkbox" class="form-check-input" id="allowMultiple" name="allowMultiple" 
                                                       th:checked="${poll != null && poll.allowMultiple}">
                                                <label class="form-check-label" for="allowMultiple">다중 선택 허용</label>
                                            </div>
                                            
                                            <div class="mb-2" id="maxSelectionsWrapper" style="display: none;">
                                                <div class="input-group">
                                                    <span class="input-group-text">최대 선택 수</span>
                                                    <input type="number" class="form-control" id="maxSelections" name="maxSelections" 
                                                           th:value="${poll != null ? poll.maxSelections : 2}" min="1" value="2">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input type="checkbox" class="form-check-input" id="allowComments" name="allowComments" 
                                                       th:checked="${poll == null || poll.allowComments}" checked>
                                                <label class="form-check-label" for="allowComments">댓글 허용</label>
                                            </div>
                                            
                                            <div class="form-check mb-2">
                                                <input type="checkbox" class="form-check-input" id="showResultsBeforeVoting" name="showResultsBeforeVoting" 
                                                       th:checked="${poll != null && poll.showResultsBeforeVoting}">
                                                <label class="form-check-label" for="showResultsBeforeVoting">투표 전 결과 표시</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 태그 -->
                                <div class="mb-3">
                                    <label for="pollTags" class="form-label">태그</label>
                                    <select class="form-control select2-multiple" id="pollTags" name="tags[]" data-toggle="select2" multiple>
                                        <option value="정치" th:selected="${poll != null && poll.tags != null && poll.tags.contains('정치')}">정치</option>
                                        <option value="경제" th:selected="${poll != null && poll.tags != null && poll.tags.contains('경제')}">경제</option>
                                        <option value="사회" th:selected="${poll != null && poll.tags != null && poll.tags.contains('사회')}">사회</option>
                                        <option value="안보" th:selected="${poll != null && poll.tags != null && poll.tags.contains('안보')}">안보</option>
                                        <option value="외교" th:selected="${poll != null && poll.tags != null && poll.tags.contains('외교')}">외교</option>
                                        <option value="교육" th:selected="${poll != null && poll.tags != null && poll.tags.contains('교육')}">교육</option>
                                        <option value="문화" th:selected="${poll != null && poll.tags != null && poll.tags.contains('문화')}">문화</option>
                                        <option value="환경" th:selected="${poll != null && poll.tags != null && poll.tags.contains('환경')}">환경</option>
                                    </select>
                                    <small class="text-muted">관련 태그를 선택하세요</small>
                                </div>
                            </div>
                            
                            <!-- 사이드바 설정 -->
                            <div class="col-xl-4 col-lg-5">
                                <!-- 상태 및 게시 설정 -->
                                <div class="card border">
                                    <div class="card-body">
                                        <h5 class="text-uppercase bg-light p-2 mt-0 mb-3">게시 설정</h5>

                                        <!-- 상태 -->
                                        <div class="mb-3">
                                            <label for="pollStatus" class="form-label">상태</label>
                                            <select class="form-select" id="pollStatus" name="status">
                                                <option value="ACTIVE" th:selected="${poll != null && poll.status == 'ACTIVE'}">진행중</option>
                                                <option value="SCHEDULED" th:selected="${poll != null && poll.status == 'SCHEDULED'}">예약됨</option>
                                                <option value="DRAFT" th:selected="${poll != null && poll.status == 'DRAFT'}">임시저장</option>
                                                <option value="COMPLETED" th:selected="${poll != null && poll.status == 'COMPLETED'}">완료</option>
                                            </select>
                                        </div>

                                        <!-- 카테고리 -->
                                        <div class="mb-3">
                                            <label for="pollCategory" class="form-label">카테고리</label>
                                            <select class="form-select" id="pollCategory" name="category">
                                                <option value="정치" th:selected="${poll != null && poll.category == '정치'}">정치</option>
                                                <option value="경제" th:selected="${poll != null && poll.category == '경제'}">경제</option>
                                                <option value="사회" th:selected="${poll != null && poll.category == '사회'}">사회</option>
                                                <option value="문화" th:selected="${poll != null && poll.category == '문화'}">문화</option>
                                                <option value="환경" th:selected="${poll != null && poll.category == '환경'}">환경</option>
                                                <option value="외교" th:selected="${poll != null && poll.category == '외교'}">외교</option>
                                                <option value="안보" th:selected="${poll != null && poll.category == '안보'}">안보</option>
                                                <option value="교육" th:selected="${poll != null && poll.category == '교육'}">교육</option>
                                            </select>